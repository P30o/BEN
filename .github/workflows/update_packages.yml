name: ğŸ›¡ï¸ ØªØ­Ø¯ÙŠØ« Ø¢Ù…Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„

on:
  push:
    paths:
      - 'debs/**'
  workflow_dispatch:

jobs:
  update_repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©

    steps:
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
      - name: â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        uses: actions/checkout@v4
        with:
          # Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§ØŒ Ø³ÙŠØ³ØªØ®Ø¯Ù… GITHUB_TOKEN ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
          fetch-depth: 0

      # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
      - name: âš™ï¸ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        run: |
          sudo apt-get update -qq
          sudo apt-get install -yqq dpkg-dev bzip2 xz-utils

      # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª
      - name: ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Packages Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
          if ! dpkg-scanpackages -m debs /dev/null > Packages; then
            echo "âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Packages"
            exit 1
          fi

          # Ø§Ù„Ø¶ØºØ· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
          bzip2 -kf Packages && [ ! -f Packages.bz2 ] && exit 1
          xz -kf Packages && [ ! -f Packages.xz ] && exit 1

      # Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ù„Ø±ÙØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ø¢Ù…Ù†
      - name: ğŸ”„ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        env:
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† GitHub
          GIT_USER: "github-actions[bot]"
          GIT_EMAIL: "41898282+github-actions[bot]@users.noreply.github.com"
        run: |
          git config --global user.name "$GIT_USER"
          git config --global user.email "$GIT_EMAIL"
          
          git add Packages*
          
          if ! git diff-index --quiet HEAD --; then
            git commit -m "ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ [skip ci]"
            git pull --rebase
            git push
            echo "âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­"
          else
            echo "ğŸ†— Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ø±ÙØ¹Ù‡Ø§"
          fi