name: 🚀 تحديث مستودع الحزم التلقائي

on:
  push:
    paths:
      - 'debs/**'
  workflow_dispatch:

jobs:
  update_packages:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ⚠️ هذا السطر ضروري للصلاحيات

    steps:
      - name: ⬇️ تحميل الكود
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}  # ⚠️ استخدم التوكن المدمج

      - name: ⚙️ إعداد البيئة
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev bzip2 xz-utils gzip

      - name: 📦 إنشاء Packages
        run: |
          dpkg-scanpackages -m debs /dev/null > Packages
          bzip2 -kf Packages
          xz -kf Packages
          gzip -kf Packages
          md5sum Packages > Packages.md5
          sha1sum Packages > Packages.sha1
          sha256sum Packages > Packages.sha256

      - name: 🔄 حفظ التغييرات
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add Packages*
          
          # تجنب الخطأ 128 بإعادة التحقق من التاريخ
          git pull --rebase  # ⚠️ هذه الخطوة جديدة
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "🔄 تحديث تلقائي [skip ci]"
            git push origin HEAD:${GITHUB_REF#refs/heads/}  # ⚠️ استخدم الصيغة الصحيحة للدفع
          fi